{% extends "library/base.html" %}

{% block content %}
    <h1>书名: {{ book.bname }}</h1>

    <img src="{{ book.bimage.url }}" alt="Not found" class="img-thumbnail myimage"/>
    <p><strong>作者：</strong> {{ book.bauthor }}</p>
    <p><strong>摘要：</strong> {{ book.bsummary|linebreaks }}</p>
    <p><strong>编号：</strong> {{ book.bid }}</p>

    <div style="margin-left:20px;margin-top:20px">
        <h4>Copies</h4>

        {% for copy in book.bookcopy.all %}
            <hr>
            <p class="{% if copy.status == 'a' %}text-success {% elif copy.status == 'm' %}text-danger {% else %}text-warning {% endif %}">
                {{ copy.get_status_display }}
            </p>
            {% if copy.status == 'o' %}
                <p><strong>归还日期：</strong> {{ copy.borrow.all.0.returndate }}</p>
                <p class="text-muted"><strong>位置：</strong> {{ copy.room }}</p>
                <button class="btn btn-primary" type="button" id="{{ copy.bcid }}" bookstatus="o">预约</button>
            {% endif %}
            {% if copy.status == 'r' %}
                {#                <p><strong>归还日期：</strong> {{ copy.borrow.all.0.returndate }}</p>#}
                <p><strong>已预约，未借走</strong></p>
                <p class="text-muted"><strong>位置：</strong> {{ copy.room }}</p>
                <button class="btn btn-primary" type="button" id="{{ copy.bcid }}" bookstatus="o">预约</button>
            {% endif %}
            {% if copy.status == 'a' %}
                <p class="text-muted"><strong>位置：</strong> {{ copy.room }}</p>
                <button class="btn btn-primary" type="button" id="{{ copy.bcid }}" bookstatus="a">借书</button>
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}

{% block script %}
    <script>
        $(document).ready(function () {
            $(":button").click(function () {
                if ($(this).attr("bookstatus") === "a") {
                    $.ajax({
                        url: "{% url 'book-borrow' %}",
                        type: "post",
                        data: {
                            "bookcopy": this.id
                        },
                        dataType: 'json',
                        timeout: 20000,
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("借书成功" + data['message'])#}
                            alert(data["message"])
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("超时")#}
                        },
                        error: function (jqXHR, textStatus, err) {
                            // jqXHR: jQuery增强的xhr
                            // textStatus: 请求完成状态
                            // err: 底层通过throw抛出的异常对象，值与错误类型有关
                            alert("错误" + e['error']);
                            {#window.clearInterval(timer)#}
                        }
                    })
                } else {
                    $.ajax({
                        url: "{% url 'book-reserve' %}",
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        timeout: 20000,
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("预约成功" + data['message'])#}
                            alert(data["message"])
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("超时"+data)#}
                        },
                        error: function (jqXHR, textStatus, err) {
                            // jqXHR: jQuery增强的xhr
                            // textStatus: 请求完成状态
                            // err: 底层通过throw抛出的异常对象，值与错误类型有关
                            alert("错误" + jqXHR['error']);
                            {#window.clearInterval(timer)#}
                        }
                    })
                }

            })
        })
    </script>
{% endblock %}
