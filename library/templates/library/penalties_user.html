{% extends "library/base.html" %}

{% block content %}
    {% load tz %}
    <h1>我的借书</h1>
    <h4>总罚金：{{ pemoney }}</h4>

    {% if borrow_list %}
        <ul>

            {% for borrow_record in borrow_list %}
                <li class="{% if borrow_record.returndate|utc < now|utc %}text-danger{% endif %}">
                    <p>
                        <a href="{% url 'book-detail' borrow_record.bookcopy.book.bid %}">{{ borrow_record.bookcopy.book.bname }}
                            ({{ borrow_record.bookcopy.book.bauthor }})
                        </a>
                    </p>
                    <p>
                        {{ borrow_record.bookcopy.room.rpos }}
                    </p>
                    <p>
                        {{ borrow_record.returndate }}
                    </p>
                    {% if borrow_record.penalty %}
                        <p>罚金：
                            {{ borrow_record.penalty.pemoney }}
                        </p>
                        <p>已逾期，无法续借</p>
                        <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}" actionstatus="return">
                            还书
                        </button>
                    {% else %}
                        <p>罚金： 0 </p>
                        <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}" actionstatus="renew">续借
                        </button>
                        <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}" actionstatus="return">
                            还书
                        </button>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

    {% else %}
        <p>没有借书。</p>
    {% endif %}
{% endblock %}

{% block script %}
    <script>
        $(document).ready(function () {
            $(":button").click(function () {
                if ($(this).attr("actionstatus") === "renew") {
                    $.ajax({
                        url: {% url 'mybooks-renew' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        {#timeout: 20000,#}
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("续借成功")
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("超时")
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                } else {
                    $.ajax({
                        url: {% url 'mybooks-return' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        timeout: 20000,
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("归还成功")
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("超时")
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                }

            })
        })
    </script>
{% endblock %}
