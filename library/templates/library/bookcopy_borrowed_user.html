{% extends "library/base.html" %}

{% block content %}
    {% load tz %}
    <h1>我的借书</h1>
    <h1>{{ pemoney }}</h1>

    {% if borrow_list %}
        <ul>

            {% for borrow_record in borrow_list %}
                <li class="{% if borrow_record.returndate|utc < now|utc %}text-danger{% endif %}">
                    <p>
                        <a href="{% url 'book-detail' borrow_record.bcid.bid.bid %}">{{ borrow_record.bcid.bid.bname }}
                            ({{ borrow_record.bcid.bid.bauthor }})
                        </a>
                    </p>
                    <p>
                        {{ borrow_record.bcid.rid.rpos }}
                    </p>
                    <p>
                        {{ borrow_record.returndate }}
                    </p>
                    <p>
                        {{ borrow_record.pemoney }}
                    </p>
                </li>
                <button class="btn btn-primary" id="{{ borrow_record.bcid.bcid }}" actionstatus="return">还书</button>
                <button class="btn btn-primary" id="{{ borrow_record.bcid.bcid }}" actionstatus="renew">续借</button>
            {% endfor %}
        </ul>

    {% else %}
        <p>There are no books borrowed.</p>
    {% endif %}
{% endblock %}

{% block script %}
    <script>
        // using jQuery
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // 这些HTTP方法不要求CSRF包含
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $(document).ready(function () {
            $(":button").click(function () {
                if ($(this).attr("actionstatus") === "renew") {
                    $.ajax({
                        url: {% url 'mybooks-renew' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        {#timeout: 20000,#}
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("续借成功")
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("超时")
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                } else {
                    $.ajax({
                        url: {% url 'mybooks-return' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        timeout: 20000,
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("归还成功")
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            alert("超时")
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                }

            })
        })
    </script>
{% endblock %}
