{% extends "library/base.html" %}

{% block content %}
    {% load tz %}
    <h1>我的借书</h1>
    <h4>总罚金：{{ pemoney }}</h4>

    {% if borrow_list %}
        <ul>

            {% for borrow_record in borrow_list %}
                <li class="{% if borrow_record.returndate|utc < now|utc %}text-danger{% endif %}">
                    <hr>
                    <div id="alert_placeholder{{ borrow_record.bookcopy.bcid }}"></div>
                    <p>
                        <a href="{% url 'book-detail' borrow_record.bookcopy.book.bid %}">{{ borrow_record.bookcopy.book.bname }}
                            ({{ borrow_record.bookcopy.book.bauthor }})
                        </a>
                    </p>
                    <div class="row">
                        <div class="col-md-4 text-muted">
                            位置：{{ borrow_record.bookcopy.room.rpos }}
                        </div>
                        <div class="col-md-4 text-muted">
                            还书时间：{{ borrow_record.returndate }}
                        </div>
                    </div>
                    {% if borrow_record.isfinished %}
                        {% if borrow_record.penalty %}
                            <div class="row">
                                <div class="col-md-4">
                                    已还书
                                </div>
                                <div class="col-md-4">
                                    罚金： {{ borrow_record.penalty.pemoney }}
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-md-4">
                                    已还书
                                </div>
                                <div class="col-md-4">
                                    罚金： 0
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if borrow_record.penalty %}
                            <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}"
                                    actionstatus="return"> 还书
                            </button>
                            <div class="row">
                                <div class="col-md-3">
                                    罚金： {{ borrow_record.penalty.pemoney }}
                                </div>
                                <div class="col-md-3">
                                    已逾期，无法续借
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}"
                                            actionstatus="return"> 还书
                                    </button>
                                </div>
                            </div>
                        {% else %}
                            <div class="row">
                                <div class="col-md-3">
                                    罚金： 0
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}"
                                            actionstatus="renew">
                                        续借
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary" id="{{ borrow_record.bookcopy.bcid }}"
                                            actionstatus="return"> 还书
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>

    {% else %}
        <p>没有借书。</p>
    {% endif %}
{% endblock %}

{% block script %}
    <script>
        $(document).ready(function () {
            $(".btn.btn-primary").click(function () {
                {#$("#btn btn-primary").click(function () {#}
                let bcid = this.id
                if ($(this).attr("actionstatus") === "renew") {
                    $.ajax({
                        url: {% url 'mybooks-renew' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        {#timeout: 20000,#}
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert(data["message"])#}
                            showalert(data["message"], data["result"], bcid)
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("超时")#}
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                } else {
                    $.ajax({
                        url: {% url 'mybooks-return' %},
                        type: "post",
                        data: {
                            "bcid": this.id
                        },
                        dataType: 'json',
                        timeout: 20000,
                        success: function (data) {
                            {#window.clearInterval(timer)#}
                            {#if(data['result'] === 'success'){#}
                            {#    alert()#}
                            {#alert(data["message"])#}
                            showalert(data["message"], data["result"], bcid)
                        },
                        complete: function (data) {
                            {#window.clearInterval(timer)#}
                            {#alert("超时")#}
                        },
                        error: function (e) {
                            alert("错误");
                            {#window.clearInterval(timer)#}
                        }
                    })
                }

            })
        })
    </script>
{% endblock %}
